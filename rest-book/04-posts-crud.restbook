[{"kind":1,"language":"markdown","value":"# Posts CRUD Flow\n\nComplete posts lifecycle: **Create → List → Get → Update → Delete**\n\nTests public/private visibility, ownership enforcement, and pagination.\n\n**Base URL:** `http://localhost:3000`\n\n> Run cells in order — variables are passed between cells.","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 0. Setup — Create user & Login\n\nRegister a test user and get an access token.","outputs":[]},{"kind":2,"language":"rest-book","value":"POST http://localhost:3000/auth/signup\nContent-Type: application/json\n\n{\n    \"email\": \"posts-test@example.com\",\n    \"password\": \"StrongP@ss123!\",\n    \"displayName\": \"Posts Tester\"\n}","outputs":[]},{"kind":2,"language":"rest-book","value":"let auth = POST http://localhost:3000/auth/login\nContent-Type: application/json\n\n{\n    \"email\": \"posts-test@example.com\",\n    \"password\": \"StrongP@ss123!\"\n}","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 1. Create a Public Post — `@Can('posts', 'create')`\n\nCreate a new post with `visibility: public`.\nRequires permission `posts:create` (enforced by PermissionsGuard).\n\nExpected: 201 Created with post data.","outputs":[]},{"kind":2,"language":"rest-book","value":"let publicPost = POST http://localhost:3000/posts\nContent-Type: application/json\nAuthorization: Bearer $auth.data.accessToken\n\n{\n    \"title\": \"My First Public Post\",\n    \"content\": \"This is a public post about hexagonal architecture and CQRS patterns in NestJS. It demonstrates clean separation of concerns.\",\n    \"visibility\": \"public\"\n}","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 2. Create a Private Post\n\nCreate a post visible only to the owner.","outputs":[]},{"kind":2,"language":"rest-book","value":"let privatePost = POST http://localhost:3000/posts\nContent-Type: application/json\nAuthorization: Bearer $auth.data.accessToken\n\n{\n    \"title\": \"My Private Draft\",\n    \"content\": \"This is a private post. Only I can see it. Work in progress...\",\n    \"visibility\": \"private\"\n}","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 3. Create a second public post\n\nAdd another public post for pagination testing.","outputs":[]},{"kind":2,"language":"rest-book","value":"let publicPost2 = POST http://localhost:3000/posts\nContent-Type: application/json\nAuthorization: Bearer $auth.data.accessToken\n\n{\n    \"title\": \"Understanding Domain-Driven Design\",\n    \"content\": \"DDD is an approach to software development that centers the development on programming a domain model that has a rich understanding of the business processes.\",\n    \"visibility\": \"public\"\n}","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 4. Create Post — No token (expect 401)\n\n`@Can('posts', 'create')` requires a valid JWT. PermissionsGuard returns 401 when no token is present.","outputs":[]},{"kind":2,"language":"rest-book","value":"POST http://localhost:3000/posts\nContent-Type: application/json\n\n{\n    \"title\": \"Unauthorized Post\",\n    \"content\": \"This should fail.\"\n}","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 5. Create Post — Invalid data (expect 400)\n\nTitle too short (min 3 chars).","outputs":[]},{"kind":2,"language":"rest-book","value":"POST http://localhost:3000/posts\nContent-Type: application/json\nAuthorization: Bearer $auth.data.accessToken\n\n{\n    \"title\": \"AB\",\n    \"content\": \"This should fail because the title is too short.\"\n}","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 6. List Public Posts (paginated)\n\nList all public posts. Private posts should NOT appear here.\n\nDefault: page 1, pageSize 20.","outputs":[]},{"kind":2,"language":"rest-book","value":"let postsList = GET http://localhost:3000/posts\n    ?page=1\n    &pageSize=20","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 7. List Posts — Custom pagination\n\nTest pagination with smaller page size.","outputs":[]},{"kind":2,"language":"rest-book","value":"GET http://localhost:3000/posts\n    ?page=1\n    &pageSize=1","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 8. Get Post by ID — `@Can('posts', 'read')` + OptionalAuth\n\nAnyone can view a public post (no auth required).\nOptionalAuthGuard allows anonymous access; PermissionsGuard skips permission check for optional routes.\nDomain PostPolicyService allows access because the post is public.\n\n> Uses `$publicPost.data.id` from step 1.","outputs":[]},{"kind":2,"language":"rest-book","value":"GET http://localhost:3000/posts/$publicPost.data.id","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 9. Get Post by ID — Private post as owner\n\nThe owner can view their own private post.\n\n> Uses `$privatePost.data.id` from step 2.","outputs":[]},{"kind":2,"language":"rest-book","value":"GET http://localhost:3000/posts/$privatePost.data.id\nAuthorization: Bearer $auth.data.accessToken","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 10. Get Post by ID — Private post as anonymous (expect 403)\n\nAnonymous users cannot view private posts.","outputs":[]},{"kind":2,"language":"rest-book","value":"GET http://localhost:3000/posts/$privatePost.data.id","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 11. Get Post — Not found (expect 404)\n\nNon-existent post ID.","outputs":[]},{"kind":2,"language":"rest-book","value":"GET http://localhost:3000/posts/00000000-0000-0000-0000-000000000000","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 12. Update Post — `@Can('posts', 'update')` + ownership\n\nUpdate the public post's title and content.\nRequires `posts:update` permission (PermissionsGuard) **and** ownership (PostPolicyService).\n\n> Uses `$publicPost.data.id` from step 1.","outputs":[]},{"kind":2,"language":"rest-book","value":"let updatedPost = PATCH http://localhost:3000/posts/$publicPost.data.id\nContent-Type: application/json\nAuthorization: Bearer $auth.data.accessToken\n\n{\n    \"title\": \"My First Public Post (Updated)\",\n    \"content\": \"Updated content: This post now covers hexagonal architecture, CQRS, and event sourcing patterns in NestJS.\"\n}","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 13. Update Post — Change visibility to private\n\nMake the public post private.","outputs":[]},{"kind":2,"language":"rest-book","value":"PATCH http://localhost:3000/posts/$publicPost.data.id\nContent-Type: application/json\nAuthorization: Bearer $auth.data.accessToken\n\n{\n    \"visibility\": \"private\"\n}","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 14. Verify the post is now private\n\nAnonymous access should be forbidden (403).","outputs":[]},{"kind":2,"language":"rest-book","value":"GET http://localhost:3000/posts/$publicPost.data.id","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 15. Delete Post — `@Can('posts', 'delete')` + ownership\n\nDelete a post. Requires `posts:delete` permission (PermissionsGuard) **and** ownership (PostPolicyService).\nReturns 204 No Content.\n\n> Uses `$publicPost2.data.id` from step 3.","outputs":[]},{"kind":2,"language":"rest-book","value":"DELETE http://localhost:3000/posts/$publicPost2.data.id\nAuthorization: Bearer $auth.data.accessToken","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 16. Verify deletion — Get deleted post (expect 404)","outputs":[]},{"kind":2,"language":"rest-book","value":"GET http://localhost:3000/posts/$publicPost2.data.id","outputs":[]},{"kind":1,"language":"markdown","value":"---\n## 17. Delete Post — No token (expect 401)\n\n`@Can('posts', 'delete')` requires a valid JWT. PermissionsGuard returns 401 when no token is present.","outputs":[]},{"kind":2,"language":"rest-book","value":"DELETE http://localhost:3000/posts/$privatePost.data.id","outputs":[]}]